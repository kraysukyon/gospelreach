@page "/notification"
@layout LandingLayout
@using GospelReachCapstone.Models
@inject GospelReachCapstone.Services.MemberService _memberService
@inject GospelReachCapstone.Services.AttendanceService _attendance
@inject IJSRuntime _js
@inject NavigationManager _nav
@inject GospelReachCapstone.Services.GroupService _groupService
@inject GospelReachCapstone.Services.GroupMemberService _groupMemberService
@inject HttpClient Http
@inject ToastService _toast
@using System.Globalization

<PageTitle>Notification Management</PageTitle>


<div class="pages">
    <!--Modal for Adding Department Head-->
    <div @onclick="ToggleBackModal" class="addUserModal @(isAddDepartmentModalVisible ? "show" : "")">
        <div hidden="@(!isView)" class="addUser" @onclick:stopPropagation>
            
            <!--Add Group-->
            <div >
                <h4 class="fw-bold">
                    @title
                </h4>
                <p style="font-size:14px;">Create group and select members.</p>

                <div class="input mt-3">
                    <p>Group Name</p>
                    <div class="pword mt-2">
                        <input @bind="group.Name" type="text" placeholder="Enter group name" />
                    </div>
                </div>

                <div>
                    <!--Table Section-->
                    <p class="mt-3">Select People</p>
                    <!--Search Section-->
                    <div class="position-relative mt-2">
                        <i class="bi bi-search position-absolute c2" style="top: .5rem; left: .75rem; font-size: 18px;"></i>
                        <input type="text" @bind="memberSearch" @bind:event="oninput" class="form-control border search" placeholder="Search name..." />
                    </div>


                    <div class="table-container mt-2 d-flex flex-column h-100 flex-grow-1">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th class="thead" style="width: auto; white-space: nowrap;"><input checked @onchange="ToggleCheckbox" type="checkbox" /></th>
                                    <th class="thead" style="width: 100%;">Name</th>
                                </tr>
                            </thead>

                            <tbody>
                                @foreach (var item in filteredMember)
                                {
                                    <tr>
                                        <td class="table-cell" style="width: auto; white-space: nowrap;">
                                            <input @bind="item.isSelected" type="checkbox" />
                                        </td>
                                        <td class="table-cell" style="width: 100%;">@item.Member.GetFullName()</td>
                                    </tr>
                                }
                            </tbody>
                        </table>

                    </div>

                    @if (validation.Any())
                    {
                        <div class="d-flex flex-column justify-content-between mt-3 mb-3">
                            @foreach (string a in validation)
                            {
                                <p class="text-danger">@a</p>
                            }
                        </div>
                    }

                    <button @onclick="CheckValidation" class="btn btn-primary p-2 text-white w-100">Save</button>

                </div>
                
            </div>

        </div>

        <!--Add Members to Group-->
        <div hidden="@(!isAddMemberVisible)" class="addMember" @onclick:stopPropagation>
            <h4 class="fw-bold">
                Add Member
            </h4>
            <p style="font-size:14px;">Create group and select members.</p>
            <!--Table Section-->

            <p class="mt-3">Select People</p>
            <!--Search Section-->
            <div class="position-relative mt-2">
                <i class="bi bi-search position-absolute c2" style="top: .5rem; left: .75rem; font-size: 18px;"></i>
                <input type="text" @bind="memberSearch" @bind:event="oninput" class="form-control border search" placeholder="Search name..." />
            </div>

            <p class="mb-2 mt-2 ms-2"><em>@addMemberMessage</em></p>

            <div class="table-container mt-2 d-flex flex-grow-1">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="thead" style="width: auto; white-space: nowrap;"><input checked @onchange="ToggleCheckbox" type="checkbox" /></th>
                            <th class="thead" style="width: 100%;">Name</th>
                        </tr>
                    </thead>

                    <tbody>
                        @foreach (var item in filteredMember)
                        {
                            <tr>
                                <td class="table-cell" style="width: auto; white-space: nowrap;">
                                    <input @bind="item.isSelected" type="checkbox" />
                                </td>
                                <td class="table-cell" style="width: 100%;">@item.Member.GetFullName()</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <button disabled="@(!filteredMember.Any(u => u.isSelected))" @onclick='() => showConfirm("addMembers",groupId)' class="btn btn-primary p-2 text-white w-100 mt-3">Save</button>
        </div>

        <!--Rename Modal-->
        <div hidden="@(!isRenameVisible)" @onclick:stopPropagation class="cards renameModal">
            <h1>
                Confirm Rename
            </h1>
            <p style="font-size:14px;">You are about to rename this group</p>

            <div class="position-relative mt-3">
                <input readonly="@(isWorking)" @bind="groupName" type="text" class="form-control border p-2" placeholder="Enter group name..." />
            </div>

            <div class="@(isUpdating ? "updating" : "dnone")">
                <p class="text-center mt-3">@updatingMessage</p>
            </div>

            @if (validation.Any())
            {
                @foreach (var a in validation)
                {
                    <p class="text-center mt-3 text-danger">@a</p>
                }
                
            }

            <div class="groupButton">
                <button class="btn border border-1 p-2 px-4" @onclick="ToggleBackModal">Cancel</button>
                <button @onclick="() => UpdateGroupName(groupId)" disabled="@(isWorking)" class="btn btn-primary px-4 p-2 text-white">Confirm</button>
            </div>
        </div>

        <!--Confirm Modal-->
        <div @onclick:stopPropagation hidden="@(!isConfirmModal)" class="helperModal">
            <div class="confirm">
                <h1>@confirmTitle</h1>
                <p>@confirmMessage</p>
            </div>

            <div class="@(isUpdating ? "updating" : "dnone")">
                <p>@updatingMessage</p>
            </div>


            @if (confirmType == "addGroup")
            {
                <div class="actions">
                    <button disabled="@(isUpdating)" class="btn p-2 px-5 fs-5" @onclick="ToggleBackModal" style="font-size: 13px; border: 1px solid #C7C7C7;">Cancel</button>
                    <button disabled="@(isUpdating)" class="btn btn-primary text-white p-2 px-5 fs-5" @onclick="AddGroupAndMembers" style="font-size: 13px; border: 1px solid #dee2e6;">Add</button>
                </div>
            }
            else if (confirmType == "deleteGroup")
            {
                <div class="actions">
                    <button disabled="@(isUpdating)" class="btn p-2 px-5 fs-5" @onclick="ToggleBackModal" style="font-size: 13px; border: 1px solid #C7C7C7;">Cancel</button>
                    <button disabled="@(isUpdating)" class="btn btn-danger text-white p-2 px-5 fs-5" @onclick="DeleteGroup" style="font-size: 13px; border: 1px solid #dee2e6;">Remove</button>
                </div>
            }
            else if (confirmType == "removeMembers")
            {
                <div class="actions">
                    <button disabled="@(isUpdating)" class="btn p-2 px-5 fs-5" @onclick="ToggleBackModal" style="font-size: 13px; border: 1px solid #C7C7C7;">Cancel</button>
                    <button disabled="@(isUpdating)" class="btn btn-danger text-white p-2 px-5 fs-5" @onclick="RemoveMembers" style="font-size: 13px; border: 1px solid #dee2e6;">Remove</button>
                </div>
            }
            else if (confirmType == "addMembers")
            {
                <div class="actions">
                    <button disabled="@(isUpdating)" class="btn p-2 px-5 fs-5" @onclick="ToggleBackModal" style="font-size: 13px; border: 1px solid #C7C7C7;">Cancel</button>
                    <button disabled="@(isUpdating)" class="btn btn-primary text-white p-2 px-5 fs-5" @onclick="AddMembers" style="font-size: 13px; border: 1px solid #dee2e6;">Confirm</button>
                </div>
            }



        </div>
    </div>

    <!--Header Section-->
    <div class="header d-block d-md-flex flex-md-row align-items-center justify-content-between mb-4">
        <div>
            <h4 class="m-0 fw-bold">Group Management</h4>
            <p class="m-0 c2" style="font-size: 14px">Manage group and members</p>
        </div>

        <button class="btn btn-primary px-4 py-2 text-white m-0 text-nowrap" @onclick="ToggleAddGroup">Add Group</button>
    </div>

    <div @onclick="HideOption" class="groupAndMembers">
        <div class="d-flex flex-grow-1">
            <!--Group Section=========================-->
            <div class="card w-100 mb-3 cardss">
                <!--Search Section-->
                <div class="d-flex gap-2">
                    <div class="position-relative w-100">
                        <i class="bi bi-search position-absolute c2" style="top: .5rem; left: .75rem; font-size: 18px;"></i>
                        <input @bind="groupSearch" @bind:event="oninput" type="text" class="form-control border search" placeholder="Search group..." />
                    </div>

                    

                </div>

                <p class="mb-2 mt-2 ms-2"><em>@groupMessage</em></p>

                <div class="table-containers flex-grow-1">
                    <table class="table">
                        <thead>
                            <tr>
                                <th class="thead">Group</th>
                                <th class="thead">Action</th>
                            </tr>
                        </thead>

                        <tbody>
                            @if (groupList != null)
                            {
                                @foreach (var item in filteredGroupList)
                                {
                                    <tr class="table-row">
                                        @if(item.Id == "All")
                                        {
                                            <td @onclick:stopPropagation @onclick="ShowAllmembers" class="table-cell" style="width: 100%; font-weight: 500;"><p>All Members</p></td>
                                        }
                                        else
                                        {
                                            <td @onclick:stopPropagation class="table-cell" style="width: 100%; font-weight: 500;" @onclick="(() => GetGroupAndMembers(item.Id, item.Name))"><p>@item.Name</p></td>
                                        }

                                        <td @onclick:stopPropagation class="table-cell @(item.Id == "All" ? "d-none" : "") d-flex gap-2" style="padding: 24px 24px; border-bottom: none;">
                                            <button class="btn p-2 px-4" @onclick="@(() => RenameGroupModal(item.Id, item.Name))" style="font-size: 13px; border: 1px solid #dee2e6;"><i class="bi bi-pencil-square"></i> Rename</button>
                                            <button class="btn btn-danger p-2 px-4 text-white" @onclick='() => showConfirm("deleteGroup", item.Id)' style="font-size: 13px; border: 1px solid #dee2e6;"><i class="bi bi-trash text-white fs-6"></i> Remove</button>
                                        </td>
                                    </tr>
                                }
                            }
                            
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!--View Group Panel-->
        <div class="groupPanel @(isViewPanel ? "grows" : "")">
            <div>
                @* <div class="d-flex gap-3 w-auto align-items-start">
                    <h4 class="m-0 fw-bold mb-3">@groupName</h4>
                </div> *@
                
                <!--Search Section-->
                <div class="d-flex gap-2">
                    <div class="position-relative w-100">
                        <i class="bi bi-search position-absolute c2" style="top: .5rem; left: .75rem; font-size: 18px;"></i>
                        <input @bind="existingMemberSearch" @bind:event="oninput" type="text" class="form-control border search" placeholder="Search member..." />
                    </div>
                </div>

                <p class="mb-2 mt-2 ms-2"><em>@viewMembersMessage</em></p>
            </div>
            

            <div class="table-containers">
                <table class="table">
                    <thead>
                        <tr>
                            <th hidden="@(isAllMember)" class="thead" style="width: auto; white-space: nowrap;"><input @onchange="ToggleMembersCheckbox" type="checkbox" /></th>
                            <th class="thead">Name</th>
                        </tr>
                    </thead>

                    <tbody>
                        @foreach (var item in filteredExistingMemberList)
                        {
                            <tr class="table-row">
                                <td hidden="@(isAllMember)" class="table-cell" style="width: auto; white-space: nowrap;">
                                    <input @bind="item.isSelected" type="checkbox" />
                                </td>
                                <td class="table-cell" style="font-weight:500;"><p>@item.Member.GetFullName()</p></td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="@(isAllMember ? "d-none" : "d-flex") gap-2 justify-content-end">
                <button disabled="@(!filteredExistingMemberList.Any() || !filteredExistingMemberList.Any(u => u.isSelected))" class="btn btn-danger px-4 py-2 text-white m-0" @onclick='() => showConfirm("removeMembers", "")' style="width: 100px;">Delete</button>
                <button class="btn btn-primary px-4 py-2 text-white m-0" @onclick="() => ToggleShowMember(groupId)" style="width: 100px;">Add</button>
            </div>

        </div>
    </div>
    
</div>

@code {
    //Variable Declarations
    private bool isAddDepartmentModalVisible = false;
    private string title = "Add Group";
    private Group group = new();
    private List<Attendance> attendancesList = new();
    private List<Group> groupList = new();
    private List<GroupMemberSelection> groupMemberList { get; set; } = new();
    private List<GroupMemberSelection> groupMemberSelectionList { get; set; } = new();
    private List<GroupMemberSelection> existingMemberList { get; set; } = new();
    private bool isValidating = false;
    private bool isView = false;
    private string groupMessage = string.Empty;
    private string attendanceMessage = string.Empty;
    private string groupMemberMessage = string.Empty;
    private string addMemberMessage = string.Empty;
    private bool isToggleGroup = false;
    private bool isAllSelected { get; set; } = true;
    private string searchString = string.Empty;
    private string memberSearch = string.Empty;
    private string groupSearch { get; set; } = string.Empty;
    private string groupMemberSearch { get; set; } = string.Empty;
    private string viewMemberSearch { get; set; } = string.Empty;
    private bool isViewPanel = false;
    private string groupName = string.Empty;
    private string groupId = string.Empty;
    private string viewMembersMessage = string.Empty;
    private bool isAddMemberVisible = false;
    private string existingMemberSearch = string.Empty;
    private bool isOptionVisible = false;
    private bool isRenameVisible = false;
    private string GroupName = string.Empty;
    private string data = string.Empty;
    private List<string> validation = new();
    TextInfo textInfo = CultureInfo.CurrentCulture.TextInfo;

    private IEnumerable<GroupMemberSelection> filteredMember => groupMemberSelectionList.Where(u => string.IsNullOrWhiteSpace(memberSearch) || u.Member.GetFullName().Contains(memberSearch, StringComparison.OrdinalIgnoreCase));
    private IEnumerable<Attendance> filteredList => attendancesList.Where(u => string.IsNullOrWhiteSpace(searchString) || u.Date.ToString().Contains(searchString, StringComparison.OrdinalIgnoreCase)).ToList();
    private IEnumerable<Group> filteredGroupList => groupList.Where(u => string.IsNullOrWhiteSpace(groupSearch) || u.Name.Contains(groupSearch, StringComparison.OrdinalIgnoreCase));
    private IEnumerable<GroupMemberSelection> filteredGroupMemberList => groupMemberList.Where(u => string.IsNullOrWhiteSpace(groupMemberSearch));
    private IEnumerable<GroupMemberSelection> filteredExistingMemberList => existingMemberList.Where(u => string.IsNullOrWhiteSpace(existingMemberSearch) || u.Member.GetFullName().Contains(existingMemberSearch, StringComparison.OrdinalIgnoreCase));

    //Email
    private string body = "Hello everyone, this is a test email!";
    private string status = "";
    private string? SelectedRow = null;

    private bool isWorking = false;
    private bool isAllMember = false;
    private bool isUpdating = false;

    //modal
    private bool isConfirmModal = false;

    //data
    private string confirmTitle = string.Empty;
    private string confirmMessage = string.Empty;
    private string updatingMessage = string.Empty;
    private string confirmType = string.Empty;

    //Load List during page initialization
    protected override async Task OnInitializedAsync()
    {
        await GetAllGroups();
    }

    //Check validation
    private async Task CheckValidation()
    {
        if (string.IsNullOrEmpty(group.Name))
        {
            validation.Add("-Group name is required.");
            return;
        }

        var groupRes = await _groupService.GetGroupsAsync();
        if (groupRes.Success)
        {
            if (groupRes.Data != null)
            {
                var check = groupRes.Data.Any(u => u.Name == group.Name);

                if (check)
                {
                    validation.Add("-Group name already exist.");
                    return;
                }
            }
        }
        else
        {
            _toast.AddNotification("error", "Something went wrong", "Please try again");
            return;
        }

        if (validation.Any())
        {
            return;
        }

        ToggleBackModal();
        showConfirm("addGroup", "");
    }

    //confirm modal
    private void showConfirm(string type, string info)
    {
        if (type != "addMembers")
        {
            ToggleBackModal();

        }
        isConfirmModal = true;
        confirmType = type;
        data = info;
        switch (type)
        {
            case "deleteGroup":
                confirmTitle = "Confirm Remove";
                confirmMessage = "You are about to remove a group and its members";
                updatingMessage = "Removing group...";
                break;
            case "addGroup":
                isView = false;
                isAddDepartmentModalVisible = true;
                confirmTitle = "Confirm Add";
                confirmMessage = "You are about to add a group";
                updatingMessage = "Adding group...";
                break;
            case "addMembers":
                isAddMemberVisible = false;
                confirmTitle = "Confirm Add";
                confirmMessage = "You are about to add members";
                updatingMessage = "Adding members...";
                break;
            case "removeMembers":
                confirmTitle = "Confirm Remove";
                confirmMessage = "You are about to remove members";
                updatingMessage = "Removing members...";
                break;
        }

    }

    private void NavigateMembers(string name)
    {
        GroupName = name;
    }

    //show all members
    private async Task ShowAllmembers()
    {
        bool isOnline = await _js.InvokeAsync<bool>("networkHelper.isOnline");

        if (!isOnline)
        {
            _toast.AddNotification("error", "Connection Error", "Check your internet connection");
            return;
        }
        existingMemberList.Clear();
        isAllMember = true;
        isViewPanel = true;
        viewMembersMessage = "Fetching data, please wait...";
        var result = await _memberService.GetMembersAsync();

        if (result.Success)
        {
            viewMembersMessage = string.Empty;
            var members = result.Data;

            existingMemberList = members.Select(u => new GroupMemberSelection
            {
                isSelected = true,
                Member = u
            }).ToList();

        }
        else
        {
            await _js.InvokeVoidAsync("alert", "Failed to get members: " + result.Error);
        }
    }

    //Update Group Name
    private async Task UpdateGroupName(string Id)
    {
        validation.Clear();
        updatingMessage = "Updating group...";
        isUpdating = true;
        bool isOnline = await _js.InvokeAsync<bool>("networkHelper.isOnline");

        if (!isOnline)
        {
            _toast.AddNotification("error", "Connection Error", "Check your internet connection");
            return;
        }
        isWorking = true;

        if (string.IsNullOrEmpty(groupName))
        {
            validation.Add("-Group name is required");
            isUpdating = false;
            isWorking = false;
            return;
        }

        var checkGroup = await _groupService.GetGroupsAsync();
        if (checkGroup.Success)
        {
            if(checkGroup.Data != null)
            {
                string gr = groupName.Trim().ToLower();
                var check = checkGroup.Data.Any(u => u.Id != Id && u.Name == groupName);
                string test = textInfo.ToTitleCase(gr);

                if (check || test == "All Members")
                {
                    validation.Add("-Group name already exist");
                    isUpdating = false;
                    isWorking = false;
                    return;
                }
            }
        }
        else
        {
            _toast.AddNotification("error", "Something went wrong", "Please try again later");
            isUpdating = false;
            isWorking = false;
            return;
        }

        groupName = textInfo.ToTitleCase(groupName);
        var result = await _groupService.RenameGroupAsync(Id, groupName);

        if (result.Success)
        {
            groupId = string.Empty;
            groupName = string.Empty;
            isViewPanel = false;
            SelectedRow = null;
            isRenameVisible = false;
            _toast.AddNotification("success", "Success", "Successfully renamed group");
            ToggleBackModal();
            await GetAllGroups();
        }
        else
        {
            _toast.AddNotification("error", "Something went wrong", "Failed to rename group");
            ToggleBackModal();
            return;
        }


    }

    //Open Rename Modal
    private void RenameGroupModal(string Id, string Name)
    {
        ToggleBackModal();
        isRenameVisible = true;
        groupId = Id;
        groupName = Name;

    }

    //Delete
    private async Task DeleteGroup()
    {
        isUpdating = true;

        bool isOnline = await _js.InvokeAsync<bool>("networkHelper.isOnline");

        if (!isOnline)
        {
            _toast.AddNotification("error", "Connection Error", "Check your internet connection");
            return;
        }



        var result = await _groupService.RemoveGroupAsync(data);

        if (result.Success)
        {
            _toast.AddNotification("success", "Success", "Successfully removed group");
            // await _js.InvokeVoidAsync("alert", "Group successfully deleted!");
            ToggleBackModal();
            await GetAllGroups();
        }
        else
        {
            ToggleBackModal();
            _toast.AddNotification("error", "Something went wrong", "Please try again later");
            // await _js.InvokeVoidAsync("alert", "Failed to delete group: " + result.Error);
        }
    }

    private void HideOption()
    {
        SelectedRow = null;
    }

    private void ToggleOption(string Id)
    {
        if (SelectedRow == Id)
        {
            SelectedRow = null;
        }
        else
        {
            SelectedRow = Id;
        }
    }

    private async Task RemoveMembers()
    {
        isUpdating = true;
        bool isOnline = await _js.InvokeAsync<bool>("networkHelper.isOnline");

        if (!isOnline)
        {
            _toast.AddNotification("error", "Connection Error", "Check your internet connection");
            ToggleBackModal();
            return;
        }
        isUpdating = true;
        var membersToDelete = existingMemberList.Where(u => u.isSelected).ToList();

        foreach (var item in membersToDelete)
        {
            var result = await _groupMemberService.RemoveGroupMembersAsync(item.Member.Id);
        }

        _toast.AddNotification("success", "Success", "Successfully removed members");
        ToggleBackModal();
        await GetGroupAndMembers(groupId,groupName);

    }

    //Toggle checkboxes
    private void ToggleMembersCheckbox(ChangeEventArgs e)
    {
        bool isCheck = (bool)e.Value!;

        foreach (var item in existingMemberList)
        {
            item.isSelected = isCheck;
        }
    }

    //Add Members to Existing group
    private async Task AddMembers()
    {
        isUpdating = true;
        bool isOnline = await _js.InvokeAsync<bool>("networkHelper.isOnline");

        if (!isOnline)
        {
            _toast.AddNotification("error", "Connection Error", "Check your internet connection");
            return;
        }

        isUpdating = true;

        var memToAdd = groupMemberSelectionList.Where(u => u.isSelected).ToList();

        if (memToAdd != null)
        {
            foreach (var item in memToAdd)
            {
                var m = new GroupMember
                {
                    GroupId = data,
                    MemberId = item.Member.Id
                };
                var result = await _groupMemberService.AddGroupMembersAsync(m);
            }

            _toast.AddNotification("success", "Success", "Successfully added members to group");
            isAddDepartmentModalVisible = !isAddDepartmentModalVisible;
            await GetGroupAndMembers(groupId, groupName);
        }
    }

    //Get All members
    private async Task GetAllMembers()
    {
        bool isOnline = await _js.InvokeAsync<bool>("networkHelper.isOnline");

        if (!isOnline)
        {
            _toast.AddNotification("error", "Connection Error", "Check your internet connection");
            return;
        }

        var result = await _memberService.GetMembersAsync();

        if (result.Success)
        {
            var members = result.Data;

            groupMemberSelectionList = members.Select(u => new GroupMemberSelection
            {
                isSelected = true,
                Member = u
            }).ToList();

        }
        else
        {
            await _js.InvokeVoidAsync("alert", "Failed to get members: " + result.Error);
        }
    }

    //Get Group and its members
    private async Task GetGroupAndMembers(string Id, string Name)
    {
        bool isOnline = await _js.InvokeAsync<bool>("networkHelper.isOnline");

        if (!isOnline)
        {
            _toast.AddNotification("error", "Connection Error", "Check your internet connection");
            return;
        }

        existingMemberList.Clear();
        isAllMember = false;
        viewMembersMessage = "Fetching data, please wait...";
        isViewPanel = true;
        groupName = Name;
        groupId = Id;

        var result = await _groupMemberService.GetGroupMembersByGroupIdAsync(Id);


        if (result.Success)
        {
            if (result.Data != null)
            {
                var results = await _memberService.GetMembersAsync();
                if (results.Success)
                {
                    var memIds = result.Data.Select(u => u.MemberId).ToHashSet();
                    var mems = results.Data.Where(u => memIds.Contains(u.Id)).ToList();

                    if (memIds == null && mems == null)
                    {
                        viewMembersMessage = "No members found";
                        return;
                    }

                    existingMemberList = mems.Select(m => new GroupMemberSelection
                    {
                        Member = m,
                        isSelected = false
                    }).ToList();

                    viewMembersMessage = string.Empty;
                }
                else
                {
                    viewMembersMessage = "There was an error retrieving the data. Please try again.";
                }
            }
            else
            {
                existingMemberList.Clear();
                viewMembersMessage = "No members found";
            }

        }
        else
        {
            await _js.InvokeVoidAsync("alert", "Failed to get data");
            viewMembersMessage = "There was an error retrieving the data. Please try again.";
        }
    }

    //Update GroupMembers and Group
    private async Task UpdateGroupAndMembers()
    {
        bool isOnline = await _js.InvokeAsync<bool>("networkHelper.isOnline");

        if (!isOnline)
        {
            _toast.AddNotification("error", "Connection Error", "Check your internet connection");
            return;
        }

        var result = await _groupService.UpdateGroupAsync(group);

        if (result.Success)
        {
            var toAdd = groupMemberList.Where(u => u.isSelected).Select(u => u.Member.Id).ToList();

            var results = await _groupMemberService.RemoveGroupMembersAsync(group.Id);
            if (results.Success)
            {
                foreach (var item in toAdd)
                {
                    var mem = new GroupMember
                    {
                        GroupId = group.Id,
                        MemberId = item
                    };
                    await _groupMemberService.AddGroupMembersAsync(mem);
                }
            }
            isAddDepartmentModalVisible = false;
            await GetAllGroups();
            await _js.InvokeVoidAsync("alert", "Group updated successfully!");
        }
        else
        {
            await _js.InvokeVoidAsync("alert", "Failed to update group: " + result.Error);
        }
    }

    //Get All Groups
    private async Task GetAllGroups()
    {
        bool isOnline = await _js.InvokeAsync<bool>("networkHelper.isOnline");

        if (!isOnline)
        {
            _toast.AddNotification("error", "Connection Error", "Check your internet connection");
            return;
        }

        groupMessage = "Fetching data, please wait...";
        groupList.Clear();
        var result = await _groupService.GetGroupsAsync();

        if (result.Success)
        {
            groupList = result.Data;
            var all = new Group { Id = "All", Name = "All Members" };
            groupList.Add(all);

            groupList = groupList.OrderByDescending(u => u.Id == "All").ThenBy(u => u.Name).ToList();

            if (groupList == null || groupList.Count == 0)
            {
                groupMessage = "No records found";
            }
            else
            {
                groupMessage = string.Empty;
            }
        }
        else
        {
            await _js.InvokeVoidAsync("alert", "Failed to get groups: " + result.Error);
            groupMessage = "Failed to get data. please refresh page";
        }
    }

    //Select All members
    private void ToggleCheckbox(ChangeEventArgs e)
    {
        isAllSelected = (bool)e.Value!;
        foreach (var item in groupMemberSelectionList)
        {
            item.isSelected = isAllSelected;
        }
    }

    private void ToggleCheckBoxUpdate(ChangeEventArgs e)
    {
        isAllSelected = (bool)e.Value!;
        foreach (var item in groupMemberList)
        {
            item.isSelected = isAllSelected;
        }
    }


    //Adding Groups and Members
    private async Task AddGroupAndMembers()
    {
        isUpdating = true;

        bool isOnline = await _js.InvokeAsync<bool>("networkHelper.isOnline");

        if (!isOnline)
        {
            _toast.AddNotification("error", "Connection Error", "Check your internet connection");
            return;
        }


        group.Name = textInfo.ToTitleCase(group.Name);
        var groupResult = await _groupService.AddGroupAsync(group);
        isAllSelected = false;

        if (groupResult.Success)
        {
            var membersToAdd = groupMemberSelectionList.Where(u => u.isSelected).Select(u => u.Member).ToList();

            if (membersToAdd != null)
            {
                foreach (var m in membersToAdd)
                {
                    var mem = new GroupMember
                    {
                        GroupId = groupResult.Id,
                        MemberId = m.Id
                    };

                    var result = await _groupMemberService.AddGroupMembersAsync(mem);
                }

                ToggleBackModal();
                _toast.AddNotification("success", "Success", "Successfully added group");
                await GetAllGroups();
            }
            else
            {
                ToggleBackModal();
                _toast.AddNotification("success", "Success", "Successfully added group");
            }

        }
        else
        {
            ToggleBackModal();
            _toast.AddNotification("error", "Something went wrong", "Please try again later");
        }
    }

    //Toggle Modal
    private void ToggleBackModal()
    {
        isAddDepartmentModalVisible = !isAddDepartmentModalVisible;
        isView = false;
        isAddMemberVisible = false;
        isConfirmModal = false;
        isViewPanel = false;
        isUpdating = false;
        isRenameVisible = false;
        isWorking = false;
    }

    private async Task ToggleAddGroup()
    {
        bool isOnline = await _js.InvokeAsync<bool>("networkHelper.isOnline");

        if (!isOnline)
        {
            _toast.AddNotification("error", "Connection Error", "Check your internet connection");
            return;
        }

        ToggleBackModal();
        validation.Clear();
        group = new();
        isAddMemberVisible = false;
        await GetAllMembers();
        isView = true;
    }

    private async Task ToggleShowMember(string Id)
    {
        bool isOnline = await _js.InvokeAsync<bool>("networkHelper.isOnline");

        if (!isOnline)
        {
            _toast.AddNotification("error", "Connection Error", "Check your internet connection");
            return;
        }

        addMemberMessage = "Fetching data, please wait...";
        groupMemberSelectionList.Clear();
        isAddDepartmentModalVisible = !isAddDepartmentModalVisible;
        isAddMemberVisible = true;
        isView = false;

        var result = await _memberService.GetMembersAsync();


        if (result.Success)
        {
            var results = await _groupMemberService.GetGroupMembersByGroupIdAsync(Id);

            if (results.Success)
            {
                if(results.Success && results.Error != null)
                {
                    groupMemberSelectionList = result.Data.Select(u => new GroupMemberSelection
                    {
                        isSelected = true,
                        Member = u
                    }).ToList();

                    addMemberMessage = string.Empty;
                }
                else
                {
                    var members = result.Data;
                    var Ids = results.Data.Select(u => u.MemberId).ToHashSet();

                    groupMemberSelectionList = members.Where(u => !Ids.Contains(u.Id)).Select(u => new GroupMemberSelection
                    {
                        isSelected = true,
                        Member = u
                    }).ToList();

                    if (groupMemberSelectionList.Count == 0)
                    {
                        addMemberMessage = "No members can be added";
                    }
                    else
                    {
                        addMemberMessage = string.Empty;
                    }
                }

            }
            else
            {
                _toast.AddNotification("error", "Something went wrong", "Failed to get members");
                // await _js.InvokeVoidAsync("Failed to get members: " + results.Error);
            }
        }
        else
        {
            // await _js.InvokeVoidAsync("alert", "Failed to get members: " + result.Error);
            _toast.AddNotification("error", "Something went wrong", "Failed to get members");
        }
    }

    //Toggle Group modal
    private void ToggleGroup()
    {
        isAllSelected = true;
        isToggleGroup = !isToggleGroup; 
    }

    private class GroupMemberSelection
    {
        public bool isSelected { get; set; }
        public Member Member { get; set; }
    }

    
}

