@page "/"
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject GospelReachCapstone.Services.FirebaseAuthenticationService FirebaseAuthService
@inject GospelReachCapstone.Services.DepartmentMemberService Firestore
@inject GospelReachCapstone.Services.AuthState Auth
@inject GospelReachCapstone.Services.AccountsService _accountService
@using GospelReachCapstone.Models;

<PageTitle>Home</PageTitle>

<div class="home">
    <!--Login Modal-->
    <div class="loginModal @(isLoginModalVisible ? "open" : "")" @onclick="showLogin">
        <div class="login" @onclick:stopPropagation>
            <img src="/img/tsalogo.png" style="width:50px;" alt="logo" />
            <h5 class="fw-bold">
                Welcome Back
            </h5>
            <p>Please enter credentials</p>

            <div class="w-100 d-flex flex-column gap-3 mt-3">
                <div class="input inputs">
                    <i class="bi bi-person" style="font-size:20px;"></i>
                    <input readonly="@(isLogginIn ? true : false)" @bind-value="email" @bind-value:event="oninput" type="text" placeholder="Email"/>
                    <i class="bi bi-eye opacity-0"></i>
                </div>
                <div class="input inputs">
                    <i class="bi bi-lock" style="padding:5px 12px;"></i>
                    <input readonly="@(isLogginIn ? true : false)" @bind="password" @bind:event="oninput" @onkeydown="HandleKeyDown" type="@(isPasswordShow ? "text" : "password")" style="font-size:15px;" placeholder="Password" />
                    <i @onclick="TogglePassword" class="@(!isPasswordShow ? "bi bi-eye-slash" : "bi bi-eye")" style="cursor:pointer"></i>

                </div>
                @* <a href="" class="text-decoration-none text-primary text-end">Forgot your password?</a> *@
                <button disabled="@isLogginIn" class="btn btn-primary w-100 py-2 mt-3" @onclick="ValidateLogin">Sign In</button>
            </div>
        </div>
    </div>


    <!--Header Section-->
    <div class="header d-flex d-md-flex align-items-center justify-content-between py-2">
        <img src="https://i.ibb.co/gbkvQP5y/tsa-crest.png" style="width:40px;" alt="tsa logo" class="logo" />
        <div class="menu @(isSidebarVisible ? "show" : "")">
            <div class="op">
                <a href="" class="text-decoration-none text-white">Events</a>
            </div>

            <div class="op">
                <a href="" class="text-decoration-none text-white">About Us</a>
            </div>

            <button class="btn btn-primary px-4 py-1 rounded rounded-pill" @onclick="showLogin">Login</button>
        </div>
        <button class="option" @onclick="showOption"><i class="bi bi-list option-icon"></i></button>
    </div>

    <!--Content1-->
    <div class="content1">
        <div class="overlay"></div>
        <div class="cont">
            <div class="wrap">
                <h1 class="t1">
                    THE SALVATION ARMY
                </h1>
                <h1 class="t2">
                    MANDAUE OUTPOST
                </h1>
            </div>

            <p>
                The Salvation Army is an international Christian organization and church,<br />
                founded in 1865, that focuses on both evangelism and social service, particularly<br />
                helping those in need, with a quasi-military structure and presence in over 130<br />
                countries.
            </p>
        </div>

    </div>

    <!--Content2-->
    <div class="content2">
        <div class="first">
            <div class="d-flex align-items-center justify-content-center">
                <div class="c1">
                    <img src="https://i.ibb.co/GvN78XCw/one-army.png" style="max-width:300px;" alt="one army" />
                </div>
            </div>

            <div class="c2 d-flex flex-column align-items-start justify-content-center gap-3">
                <h5 class="fw-bold">
                    About Mandaue Outpost
                </h5>
                <p class="text-wrap">The Salvation Army is a Protestant Christian church and an international charitable organization headquartered in London, England. It is aligned with the Wesleyan-Holiness movement.  The Salvation Army is a Protestant Christian church and an international charitable organisation headquartered in London, England. It is aligned with the Wesleyan-Holiness movement.</p>
            </div>
        </div>

        <div class="second">
            <div class="d-flex flex-column align-items-start justify-content-center gap-3">
                <h5 class="fw-bold">Featured Events</h5>
                <p class="text-wrap">The Salvation Army is a Protestant Christian church and an international charitable organisation headquartered in London, England. It is aligned with the Wesleyan-Holiness movement.  The Salvation Army is a Protestant Christian church and an international charitable organization headquartered in London, England. It is aligned with the Wesleyan-Holiness movement. </p>
            </div>

            <!--Featured Events-->
            <div class="eventsContainer">
                <div class="block">
                    <div class="event">
                        <div class="h-auto">
                            <img src="https://i.ibb.co/SXcCGNv0/event.png" alt="event" />
                        </div>


                        <div class="sub">
                            <h5 class="fw-bold">Year End Party 2025</h5>
                            <h6 class="text-primary fw-bold">Yearly Party</h6>
                            <p class="text-wrap mt-2">The Salvation Army is a Protestant Christian church and an international charitable organisation headquartered</p>
                        </div>
                    </div>

                    <div class="event">
                        <div class="h-auto">
                            <img src="https://i.ibb.co/SXcCGNv0/event.png" alt="event" />
                        </div>


                        <div class="sub">
                            <h5 class="fw-bold">Year End Party 2025</h5>
                            <h6 class="text-primary fw-bold">Yearly Party</h6>
                            <p class="text-wrap mt-2">The Salvation Army is a Protestant Christian church and an international charitable organisation headquartered</p>
                        </div>
                    </div>

                    <div class="event">
                        <div class="h-auto">
                            <img src="https://i.ibb.co/SXcCGNv0/event.png" alt="event" />
                        </div>


                        <div class="sub">
                            <h5 class="fw-bold">Year End Party 2025</h5>
                            <h6 class="text-primary fw-bold">Yearly Party</h6>
                            <p class="text-wrap mt-2">The Salvation Army is a Protestant Christian church and an international charitable organisation headquartered</p>
                        </div>
                    </div>
                </div>

                <div class="block">
                    <div class="event">
                        <div class="h-auto">
                            <img src="https://i.ibb.co/SXcCGNv0/event.png" alt="event" />
                        </div>


                        <div class="sub">
                            <h5 class="fw-bold">Year End Party 2025</h5>
                            <h6 class="text-primary fw-bold">Yearly Party</h6>
                            <p class="text-wrap mt-2">The Salvation Army is a Protestant Christian church and an international charitable organisation headquartered</p>
                        </div>
                    </div>

                    <div class="event">
                        <div class="h-auto">
                            <img src="https://i.ibb.co/SXcCGNv0/event.png" alt="event" />
                        </div>


                        <div class="sub">
                            <h5 class="fw-bold">Year End Party 2025</h5>
                            <h6 class="text-primary fw-bold">Yearly Party</h6>
                            <p class="text-wrap mt-2">The Salvation Army is a Protestant Christian church and an international charitable organisation headquartered</p>
                        </div>
                    </div>

                    <div class="event">
                        <div class="h-auto">
                            <img src="https://i.ibb.co/SXcCGNv0/event.png" alt="event" />
                        </div>


                        <div class="sub">
                            <h5 class="fw-bold">Year End Party 2025</h5>
                            <h6 class="text-primary fw-bold">Yearly Party</h6>
                            <p class="text-wrap mt-2">The Salvation Army is a Protestant Christian church and an international charitable organisation headquartered</p>
                        </div>
                    </div>
                </div>
            </div>


        </div>
    </div>

    <!--End Container-->
    <div class="endContainer">
        <div class="end1">
            <div class="w-auto">
                <div class="d-flex gap-4 align-items-center justify-content-center">
                    <img src="/img/tsalogo-bnw.png" alt="tsa logo" />
                    <h5 class="fw-bold">Mandaue<br />Outpost</h5>
                </div>
                <p class="text-wrap mt-2 text-center">
                    Mandaue Outpost Head Coordinator:<br />
                    Aprilyn Nanlabi
                </p>
            </div>
        </div>

        <div class="end2">
            <h5 class="fw-bold mb-2">Contact Us</h5>
            <div class="e1">
                <div class="d-flex gap-3">
                    <i class="bi bi-telephone"></i>
                    <p>(+63)990-213-5432)</p>
                </div>
                <div class="d-flex gap-3">
                    <i class="bi bi-envelope"></i>
                    <p>tsamandauecorps@gmail.com</p>
                </div>
                <div class="d-flex gap-3">
                    <i class="bi bi-geo-alt"></i>
                    <p>F. Mendoza Street Cambaro, Mandaue City<br />Cebu, Philippines</p>
                </div>
            </div>
        </div>
    </div>
    <!--End of Container-->
    <!--Closing-->
    <div class="close">
        <p>All Rights Reserved: Copyright © 2025</p>
    </div>
</div>


@code {
    private bool isLoginModalVisible = false;
    private bool isSidebarVisible = false;
    private bool isLogginIn = false;
    private bool isPasswordShow = false;

    //variables for authentication
    private string email = string.Empty;
    private string password = string.Empty;
    private List<User> accounts = new();

    protected override async Task OnInitializedAsync()
    {

        if (Auth.IsLoggedIn)
        {
            await FirebaseAuthService.LogoutAsync(); // Ensure user is logged out on initialization
        }
    }

    private void TogglePassword()
    {
        isPasswordShow = !isPasswordShow;
    }

    private void showOption()
    {
        isSidebarVisible = !isSidebarVisible;
    }

    private void showLogin()
    {
        isSidebarVisible = false;
        isLoginModalVisible = !isLoginModalVisible;
    }

    private void closeModal()
    {
        isLoginModalVisible = false;
        isSidebarVisible = false;
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await ValidateLogin();
        }
    }

    private async Task ValidateLogin()
    {
        isLogginIn = !isLogginIn;

        var results = await FirebaseAuthService.LoginAsync(email, password);
        if (results.Success)
        {
            var result = await _accountService.GetUserAccountsAsync();
            if (result.Success)
            {
                if (result.Data != null)
                {
                    var data = result.Data;

                    var user = result.Data.FirstOrDefault(u => u.Email == email);

                    if (user != null)
                    {
                        if (user.Status != "Disabled")
                        {
                            await JSRuntime.InvokeVoidAsync("alert", "Login Success");
                            NavigationManager.NavigateTo("dashboard");
                        }
                        else
                        {
                            await JSRuntime.InvokeVoidAsync("alert", "The account is disabled. Please contact administrator");
                        }
                    }
                    else
                    {
                        await JSRuntime.InvokeVoidAsync("alert", "Invalid email or password");
                    }
                }
                else
                {
                    await JSRuntime.InvokeVoidAsync("alert", "No data found");
                }
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", result.Error);
            }
        }
        else
        {
            await JSRuntime.InvokeVoidAsync("alert", results.Error);
        }

        

        

        // try
        // {
        //     var res


        //     var result = await FirebaseAuthService.LoginAsync(email, password);
        //     if (result.Success)
        //     {
        //         await JSRuntime.InvokeVoidAsync("alert", result.Message);
        //         NavigationManager.NavigateTo("dashboard"); 
        //     }
        //     else
        //     {
        //         await JSRuntime.InvokeVoidAsync("alert", result.Message); 
        //     }
        // }
        // catch (Exception ex)
        // {
        //     await JSRuntime.InvokeVoidAsync("alert", $"An error occurred: {ex.Message}"); 
        // }
        isLogginIn = !isLogginIn;

    }

}